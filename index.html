<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fresko - Аватар</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;touch-action:manipulation}
        html,body{width:100%;height:100%;overflow:hidden;position:fixed;background:#000;color:#fff;font-family:'Segoe UI',system-ui,sans-serif}
        body{display:flex;justify-content:center;align-items:center;padding:15px}
        .background{position:fixed;top:0;left:0;width:100%;height:100%;z-index:-2}
        #background-video{width:100%;height:100%;object-fit:cover;opacity:0.15}
        .container{width:100%;max-width:500px;display:flex;flex-direction:column;align-items:center;gap:20px;padding:20px;z-index:1}
        .avatar-container{width:180px;height:180px;border-radius:50%;overflow:hidden;border:4px solid #3D3B3C;box-shadow:0 0 25px rgba(255,255,255,0.15);animation:glow 3s infinite alternate}
        @keyframes glow{0%{box-shadow:0 0 20px rgba(255,255,255,0.1)}100%{box-shadow:0 0 30px rgba(255,255,255,0.2)}}
        .avatar-video,.avatar-image{width:100%;height:100%;object-fit:cover}
        .avatar-image{display:none}
        .name-text{font-size:28px;font-weight:700;background:linear-gradient(45deg,#fff,#aaa);-webkit-background-clip:text;background-clip:text;color:transparent;text-align:center;margin-bottom:5px}
        .phone-text{font-size:14px;color:#888;text-align:center;margin-bottom:15px}
        .counter-section{width:100%;text-align:center;margin:10px 0}
        .counter-label{font-size:12px;color:#666;margin-bottom:8px;letter-spacing:1px}
        .counter-display{display:flex;justify-content:center;align-items:center;gap:3px;height:50px;background:rgba(61,59,60,0.3);border-radius:10px;border:1px solid #444;padding:0 15px;margin:0 auto;max-width:300px}
        .digit{font-size:24px;font-weight:bold;color:#fff;min-width:20px;text-align:center;transition:all 0.2s}
        .digit.new{color:#ff3838;transform:scale(1.3)}
        .buttons-container{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;width:100%;max-width:400px;margin-top:10px}
        .btn{height:50px;background:linear-gradient(145deg,#ff3838,#ff5757);color:white;border:none;border-radius:10px;font-size:13px;display:flex;align-items:center;justify-content:center;gap:8px;text-decoration:none;transition:all 0.3s ease;cursor:pointer;position:relative;overflow:hidden}
        .btn::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.2),transparent);transition:left 0.7s}
        .btn:hover::before{left:100%}
        .btn:hover{background:linear-gradient(145deg,#ff5757,#ff3838);transform:translateY(-3px);box-shadow:0 5px 15px rgba(255,56,56,0.3)}
        .btn:active{transform:translateY(-1px)}
        .btn-icon{font-size:16px;position:relative;z-index:1}
        .btn span{position:relative;z-index:1}
        .sound-toggle{position:fixed;top:15px;left:15px;width:40px;height:40px;background:rgba(61,59,60,0.9);border:1px solid #444;border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;cursor:pointer;z-index:1000;font-size:18px;transition:all 0.3s ease}
        .sound-toggle:hover{transform:scale(1.1);background:#ff3838}
        .sound-toggle.muted::after{content:'';position:absolute;top:50%;left:50%;width:24px;height:2px;background:#ff3838;transform:translate(-50%,-50%) rotate(45deg)}
        @media (min-width:768px){.avatar-container{width:200px;height:200px}.name-text{font-size:32px}.phone-text{font-size:16px}.buttons-container{grid-template-columns:repeat(3,1fr);max-width:500px}.btn{height:55px;font-size:14px}}
        @media (max-width:480px){.container{padding:10px;gap:15px}.avatar-container{width:150px;height:150px}.name-text{font-size:24px}.counter-display{height:45px;padding:0 10px}.digit{font-size:20px}.buttons-container{gap:8px}.btn{height:45px;font-size:12px}}
        .debug-info{position:fixed;bottom:10px;right:10px;background:rgba(0,0,0,0.7);color:#0f0;padding:5px;font-size:10px;border-radius:3px;display:none;z-index:9999}
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="background">
        <video id="background-video" autoplay loop muted playsinline>
            <source src="fon.mp4" type="video/mp4">
        </video>
    </div>
    
    <button class="sound-toggle" id="soundToggle">
        <i class="fas fa-volume-up"></i>
    </button>
    
    <div class="debug-info" id="debugInfo"></div>
    
    <div class="container">
        <div class="avatar-container">
            <video class="avatar-video" autoplay loop muted playsinline>
                <source src="avatar.mp4" type="video/mp4">
                <img class="avatar-image" src="ava.png" alt="Аватар">
            </video>
        </div>
        
        <div class="name-text">Максим [Fresko]</div>
        <div class="phone-text">+888 888 088</div>
        
        <div class="counter-section">
            <div class="counter-label">ПОСЕЩЕНИЙ:</div>
            <div class="counter-display" id="counterDisplay">
                <div class="digit">0</div>
                <div class="digit">0</div>
                <div class="digit">0</div>
            </div>
        </div>
        
        <div class="buttons-container">
            <a href="https://t.me/+IjiAqcTamdNhM2E6" target="_blank" class="btn">
                <i class="fab fa-telegram btn-icon"></i>
                <span>Канал</span>
            </a>
            <a href="https://t.me/FreskoKeySeller_bot" target="_blank" class="btn">
                <i class="fas fa-store btn-icon"></i>
                <span>Магазин</span>
            </a>
            <a href="https://t.me/BioFresko/18" target="_blank" class="btn">
                <i class="fas fa-user btn-icon"></i>
                <span>Обо мне</span>
            </a>
            <a href="https://t.me/ProjectFresko" target="_blank" class="btn">
                <i class="fas fa-project-diagram btn-icon"></i>
                <span>Проекты</span>
            </a>
            <a href="https://t.me/FreskoChats" target="_blank" class="btn">
                <i class="fas fa-comments btn-icon"></i>
                <span>Чат</span>
            </a>
            <a href="https://t.me/FreskoWIN" target="_blank" class="btn">
                <i class="fas fa-user-circle btn-icon"></i>
                <span>Мой лс</span>
            </a>
        </div>
    </div>
    
    <audio id="backgroundMusic" loop>
        <source src="Top.mp3" type="audio/mpeg">
    </audio>

    <script>
        const SUPABASE_URL = 'https://gcxujsoqiywkiruzrqdg.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdjeHVqc29xaXl3a2lydXpycWRnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5MDY0MDIsImV4cCI6MjA4MTQ4MjQwMn0.B4HCviU2uMbUgtBILaFc5p0V6Pvj-0G8eKS-AEMu8as';
        
        let backgroundMusic;
        let isMusicPlaying = true;
        let supabaseClient = null;
        let counterValue = 0;

        document.addEventListener('DOMContentLoaded', async function() {
            // Показываем начальные 000
            animateCounter(0);
            
            // Настройка музыки
            setupMusic();
            
            // Инициализируем Supabase
            try {
                supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                console.log('Supabase инициализирован');
            } catch (error) {
                console.error('Ошибка инициализации Supabase:', error);
            }
            
            // Запускаем счетчик
            await handleCounter();
            
            // Настройка аватара
            setupAvatar();
            
            // Предотвращение масштабирования
            document.addEventListener('gesturestart', (e) => e.preventDefault());
            document.addEventListener('dblclick', (e) => e.preventDefault());
        });

        function setupMusic() {
            backgroundMusic = document.getElementById('backgroundMusic');
            const soundToggle = document.getElementById('soundToggle');
            
            if (!backgroundMusic) return;
            
            backgroundMusic.volume = 0.4;
            
            const savedMuted = localStorage.getItem('fresko_music_muted');
            if (savedMuted === 'true') {
                backgroundMusic.muted = true;
                soundToggle.classList.add('muted');
                isMusicPlaying = false;
            }
            
            const unlockAudio = () => {
                try {
                    backgroundMusic.play().catch(e => console.log('Аудио не запустилось:', e));
                } catch (e) {}
                document.removeEventListener('click', unlockAudio);
                document.removeEventListener('touchstart', unlockAudio);
            };
            
            document.addEventListener('click', unlockAudio);
            document.addEventListener('touchstart', unlockAudio);
            
            setTimeout(() => {
                try {
                    backgroundMusic.play().catch(e => console.log('Автоплей не сработал:', e));
                } catch (e) {}
            }, 1000);
            
            soundToggle.addEventListener('click', toggleMusic);
        }

        function toggleMusic() {
            if (!backgroundMusic) return;
            
            isMusicPlaying = !isMusicPlaying;
            backgroundMusic.muted = !isMusicPlaying;
            
            const soundToggle = document.getElementById('soundToggle');
            
            if (isMusicPlaying) {
                soundToggle.classList.remove('muted');
                localStorage.setItem('fresko_music_muted', 'false');
            } else {
                soundToggle.classList.add('muted');
                localStorage.setItem('fresko_music_muted', 'true');
            }
        }

        async function handleCounter() {
            // Сначала всегда показываем анимацию от 0 до начального значения
            const initialValue = 0;
            
            // Пытаемся получить или создать счетчик в базе
            try {
                if (!supabaseClient) {
                    console.warn('Supabase не подключен, используем локальное значение');
                    // Используем localStorage как запасной вариант
                    let localCount = localStorage.getItem('fresko_local_counter');
                    if (!localCount) {
                        localCount = 1;
                    } else {
                        localCount = parseInt(localCount) + 1;
                    }
                    localStorage.setItem('fresko_local_counter', localCount);
                    animateCounter(localCount);
                    return;
                }
                
                // Пробуем получить текущее значение
                const { data: currentData, error: fetchError } = await supabaseClient
                    .from('counter')
                    .select('value')
                    .eq('id', 1)
                    .single();
                
                console.log('Получены данные из БД:', currentData, 'Ошибка:', fetchError);
                
                if (fetchError || !currentData) {
                    // Записи нет - создаем новую
                    console.log('Создаем новую запись в БД...');
                    const newValue = 1;
                    
                    const { error: insertError } = await supabaseClient
                        .from('counter')
                        .insert({ 
                            id: 1, 
                            value: newValue 
                        });
                    
                    if (insertError) {
                        console.error('Ошибка при создании записи:', insertError);
                        // Используем localStorage
                        let localCount = localStorage.getItem('fresko_local_counter');
                        if (!localCount) localCount = 1;
                        else localCount = parseInt(localCount) + 1;
                        localStorage.setItem('fresko_local_counter', localCount);
                        animateCounter(localCount);
                    } else {
                        console.log('Запись создана со значением:', newValue);
                        animateCounter(newValue);
                    }
                } else {
                    // Запись есть - увеличиваем на 1
                    const newValue = currentData.value + 1;
                    console.log('Увеличиваем счетчик с', currentData.value, 'до', newValue);
                    
                    const { error: updateError } = await supabaseClient
                        .from('counter')
                        .update({ value: newValue })
                        .eq('id', 1);
                    
                    if (updateError) {
                        console.error('Ошибка при обновлении:', updateError);
                        // Показываем старое значение +1 даже если не обновили
                        animateCounter(newValue);
                    } else {
                        console.log('Счетчик обновлен до:', newValue);
                        animateCounter(newValue);
                    }
                }
                
            } catch (error) {
                console.error('Критическая ошибка в счетчике:', error);
                // Запасной вариант - рандомное число
                const fallbackValue = Math.floor(Math.random() * 1000) + 100;
                animateCounter(fallbackValue);
            }
        }

        function animateCounter(end) {
            const counterDisplay = document.getElementById('counterDisplay');
            if (!counterDisplay) {
                console.error('Не найден counterDisplay!');
                return;
            }
            
            console.log('Запускаем анимацию до:', end);
            
            // Очищаем дисплей
            counterDisplay.innerHTML = '';
            
            // Определяем количество цифр (минимум 3)
            const digitsCount = Math.max(end.toString().length, 3);
            const digitElements = [];
            
            // Создаем цифры
            for (let i = 0; i < digitsCount; i++) {
                const digitElement = document.createElement('div');
                digitElement.className = 'digit';
                digitElement.textContent = '0';
                digitElement.dataset.index = i;
                counterDisplay.appendChild(digitElement);
                digitElements.push(digitElement);
            }
            
            // Запускаем анимацию от 0 до конечного значения
            let startTimestamp = null;
            const duration = 1500; // 1.5 секунды
            
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                
                // Плавное увеличение с easing
                const easeProgress = 1 - Math.pow(1 - progress, 3);
                const currentValue = Math.floor(easeProgress * (end - 0) + 0);
                
                updateDigits(currentValue, digitElements);
                
                if (progress < 1) {
                    window.requestAnimationFrame(step);
                }
            };
            
            window.requestAnimationFrame(step);
        }

        function updateDigits(value, digitElements) {
            // Форматируем число с пробелами
            const formattedValue = value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
            const valueDigits = formattedValue.split('');
            
            // Обновляем каждую цифру
            digitElements.forEach((digitElement, index) => {
                const digitIndex = digitElements.length - valueDigits.length + index;
                const digitValue = digitIndex >= 0 ? valueDigits[digitIndex] : '0';
                
                if (digitElement.textContent !== digitValue) {
                    digitElement.textContent = digitValue;
                    digitElement.classList.add('new');
                    
                    setTimeout(() => {
                        digitElement.classList.remove('new');
                    }, 300);
                }
            });
        }

        function setupAvatar() {
            const avatarVideo = document.querySelector('.avatar-video');
            const avatarImage = document.querySelector('.avatar-image');
            
            if (!avatarVideo || !avatarImage) return;
            
            // Если видео не загрузилось за 3 секунды - показываем картинку
            setTimeout(() => {
                if (avatarVideo.readyState < 2) { // HAVE_CURRENT_DATA или меньше
                    console.log('Видео не загрузилось, показываем картинку');
                    avatarVideo.style.display = 'none';
                    avatarImage.style.display = 'block';
                }
            }, 3000);
            
            avatarVideo.addEventListener('error', () => {
                console.log('Ошибка загрузки видео, показываем картинку');
                avatarVideo.style.display = 'none';
                avatarImage.style.display = 'block';
            });
        }

        window.addEventListener('beforeunload', () => {
            if (backgroundMusic) {
                backgroundMusic.pause();
            }
        });

        // Функция для принудительного сброса счетчика (для теста)
        window.resetCounter = async function() {
            if (!supabaseClient) {
                alert('Supabase не подключен!');
                return;
            }
            
            const { error } = await supabaseClient
                .from('counter')
                .update({ value: 0 })
                .eq('id', 1);
            
            if (error) {
                alert('Ошибка сброса: ' + error.message);
            } else {
                alert('Счетчик сброшен к 0!');
                location.reload();
            }
        };

        // Включаем отладку по нажатию Ctrl+Shift+D
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.shiftKey && e.key === 'D') {
                const debugInfo = document.getElementById('debugInfo');
                debugInfo.style.display = debugInfo.style.display === 'block' ? 'none' : 'block';
                debugInfo.textContent = `Счетчик: ${counterValue}\nURL: ${SUPABASE_URL}`;
            }
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</body>
</html>
